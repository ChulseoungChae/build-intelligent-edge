{% extends "layout.html" %}

{% block content %}
<div id="chart-container"></div>
<div id="column-selector"></div>
<button onclick="resetZoom()">원래 상태로 복원</button>

<script>
    let currentLayout = null; // 현재 레이아웃(줌인/줌아웃 상태)을 저장할 변수
    let selectedColumns = new Set(); // 선택된 칼럼들을 저장할 집합
    let intervalId = null; // setInterval ID 저장

    function loadRealtimeChart() {
        if (intervalId) {
            clearInterval(intervalId);
        }
        intervalId = setInterval(fetchRealtimeData, 1000);
    }

    function fetchRealtimeData() {
        fetch('/realtime-data')
            .then(response => response.json())
            .then(data => {
                var chartData = JSON.parse(data);
                if (selectedColumns.size > 0) {
                    chartData.data = chartData.data.filter(trace => selectedColumns.has(trace.name));
                } else {
                    chartData.data.forEach(trace => selectedColumns.add(trace.name));
                }
                Plotly.react('chart-container', chartData.data, chartData.layout);
                document.getElementById('chart-container').on('plotly_relayout', function(eventdata) {
                    currentLayout = eventdata;
                });

                if (document.getElementById('column-selector').childElementCount === 0) {
                    createColumnSelector(chartData.data.map(trace => trace.name));
                } else {
                    updateCheckboxStates(chartData.data.map(trace => trace.name));
                }
            });
    }

    function resetZoom() {
        currentLayout = null;
        loadRealtimeChart();
    }

    function createColumnSelector(columnNames) {
        const container = document.getElementById('column-selector');
        columnNames.forEach(name => {
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = name;
            checkbox.checked = selectedColumns.has(name);
            checkbox.onchange = function() {
                if (this.checked) {
                    selectedColumns.add(name);
                } else {
                    selectedColumns.delete(name);
                }
                fetchRealtimeData();
            };
            const label = document.createElement('label');
            label.htmlFor = name;
            label.innerText = name;
            container.appendChild(checkbox);
            container.appendChild(label);
            container.appendChild(document.createElement('br'));
        });
    }

    function updateCheckboxStates(columnNames) {
        columnNames.forEach(name => {
            const checkbox = document.getElementById(name);
            if (checkbox) {
                checkbox.checked = selectedColumns.has(name);
            }
        });
    }

    loadRealtimeChart();
</script>
{% endblock %}
